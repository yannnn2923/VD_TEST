@Library('build_libs') _

// Propri√©t√©s du job
properties([
    buildDiscarder(logRotator(numToKeepStr: "10"))
])
withTools([
    [name: 'buildkit', image: 'moby/buildkit', version:'rootless']
]) {
        stage('R√©cup√©ration code source') {
            println 'üî∞ R√©cup√©ration du code source'
            scmInfo = checkout scm
            println '‚úîÔ∏è R√©cup√©ration du code source effectu√©e'
        }
        stage('Build docker') {
                println 'üìú build Docker avec Buildkit'
                env.IMAGE_NAME = 'vda3'
                //env.IMAGE_NAME = 'registry-docker.apps.eul.sncf.fr/04374.dev/vda3'
                env.IMAGE_VERSION = '1.0.0'
                container('buildkit') {
                    result = sh(script: "eul image build ./application/ --tag=$IMAGE_NAME:$IMAGE_VERSION", returnStatus: true)
                    if (result != 0) {
                        error '‚ùå Le build Docker avec BuildKit a √©chou√©'
                    }
                }
                println '‚úîÔ∏è build Docker effectu√©'
        }
        currentBuild.result = 'SUCCESS'
}

